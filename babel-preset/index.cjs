"use strict";var e=require("@babel/core"),t=require("@babel/helper-plugin-utils"),n=require("@babel/plugin-syntax-jsx"),s=require("@babel/helper-module-imports"),r=require("validate-html-nesting");function i(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function o(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const a=(t,n,r)=>o(n,"id/"+r,function(t,n,r){return()=>{let a=i(n,`imports/${r}`);return a?e.types.cloneNode(a):(a=s.addNamed(t,r,"pota/jsx-runtime",{importedInterop:"uncompiled",importPosition:"after"}),o(n,`imports/${r}`,a),a)}}(t,n,r)),p=(t,n,s)=>e.types.callExpression(i(t,`id/${n}`)(),s),u=(t,n)=>e.types.callExpression(e.types.identifier(t),n);function l(e,t){throw e.buildCodeFrameError(t)}function c(e,t){const n=e.indexOf(t);return-1!==n&&e.splice(n,1),e}const m=Object.keys;function d(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+g(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function f(t){return e.types.isStringLiteral(t.value.expression)||e.types.isNumericLiteral(t.value.expression)?String(t.value.expression.value):String(t.value.value)}const g=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function y(e){const t=[];let n=0,s=e[n],r=e[++n];for(;s&&r;){if(P(s)){if(P(r)){s.value+=$(r),t.push(r),r=e[++n];continue}if(L(r)){r.arguments[0].value=$(s)+X(r),t.push(s),s=r,r=e[++n];continue}}if(L(s)){if(P(r)){s.arguments[0].value+=$(r),t.push(r),r=e[++n];continue}if(L(r)){s.arguments[0].value+=X(r),s.arguments[1].elements.push(...r.arguments[1].elements),t.push(r),r=e[++n];continue}}s=r,r=e[++n]}return e.filter((e=>!t.includes(e)))}function h(t,n){const s=t.reduce(x,[]);if(n&&n.length>0&&s.push(function(t){let n;if(1===t.length)n=t[0];else{if(!(t.length>1))return;n=e.types.arrayExpression(t)}return e.types.objectProperty(e.types.identifier("children"),n)}(n)),s.length)return e.types.objectExpression(function(e){e&&e.sort(((e,t)=>"children"===e.key?.name?2:e.key?.name?.localeCompare(t.key?.name)));return e}(s))}function x(t,n){if(n="node"in n?n.node:n,e.types.isJSXSpreadAttribute(n)){const s=n.argument;return e.types.isObjectExpression(s)&&!b(s)?t.push(...s.properties):t.push(e.types.spreadElement(s)),t}const s=(r=n.value||e.types.booleanLiteral(!0),e.types.isJSXExpressionContainer(r)?r.expression:r);var r,i;e.types.isStringLiteral(s)&&!e.types.isJSXExpressionContainer(n.value)&&(s.value=s.value.replace(/\n\s+/g," "),null==(i=s.extra)||delete i.raw);return e.types.isJSXNamespacedName(n.name)?n.name=e.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):e.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=e.types.stringLiteral(n.name.name),t.push(e.types.inherits(e.types.objectProperty(n.name,s),n)),t}const b=t=>t.properties.some((t=>e.types.isObjectProperty(t,{computed:!1,shorthand:!1})&&(e.types.isIdentifier(t.key,{name:"__proto__"})||e.types.isStringLiteral(t.key,{value:"__proto__"}))));function v(t){const n=t.get("openingElement"),s=S(n.node.name,n.node);let r;return e.types.isIdentifier(s)?r=s.name:e.types.isStringLiteral(s)&&(r=s.value),e.types.react.isCompatTag(r)?r:""}function S(t,n){return e.types.isJSXIdentifier(t)?"this"===t.name&&e.types.isReferenced(t,n)?e.types.thisExpression():e.types.isValidIdentifier(t.name,!1)?(t.type="Identifier",t):e.types.stringLiteral(t.name):e.types.isJSXMemberExpression(t)?e.types.memberExpression(S(t.object,t),S(t.property,t)):e.types.isJSXNamespacedName(t)?e.types.stringLiteral(`${t.namespace.name}:${t.name.name}`):t}function E(t,n){const s=v(t),r={tagName:s,content:`<${s}`,props:[]};let i=!1,o=s.includes("-"),a=o,u="";const l=[(c="#pota",m="",e.types.jSXAttribute(e.types.jSXIdentifier(c),e.types.stringLiteral(m)))];var c,m,g;for(const n of t.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&e.types.isJSXIdentifier(n.node.name)){const t=n.node.name.name;if(o=o||"is"===t,a=a||"img"===s&&"loading"===t,"xmlns"===t&&(i=!0),g=n.node,e.types.isStringLiteral(g.value)||e.types.isNumericLiteral(g.value)||e.types.isStringLiteral(g.value?.expression)||e.types.isNumericLiteral(g.value?.expression)){if("xmlns"===t){u=f(n.node);continue}d(r,t,f(n.node));continue}}l.push(n)}if(!i)switch(s){case"svg":i=!0,u="http://www.w3.org/2000/svg";break;case"math":i=!0,u="http://www.w3.org/1998/Math/MathML"}J(s)?r.content+=" />":r.content+=">";let x=e.types.react.buildChildren(t.node);!function(e,t){for(const n of t)N(n)&&j(e,n.tagName,n)}(r.tagName,x),x=function(e,t){const n=[];for(let s=0;s<e.length;s++){const r=e[s];if(P(r))t.content+=$(r),n.push(r);else{if(!L(r))break;t.content+=X(r),t.props.push(...r.arguments[1].elements),n.push(r)}}return e.filter((e=>!n.includes(e)))}(x,r),x=y(x),r.props.unshift(h(l,x)),J(s)||(r.content+=`</${s}>`);const b=p(n,"createPartial",[e.types.stringLiteral(r.content),e.types.arrayExpression(r.props)]);return b.isPartial=!0,b.isXML=i,b.xmlns=u,b.isImportNode=a,b.isCustomElement=o,b.tagName=s,b._path=t,b}function L(e){return e.isPartial&&!e.isXML&&!e.isImportNode&&!e.isCustomElement}function N(e){return e.isPartial}function X(e){return e.arguments[0].value}const C=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function J(e){return C.has(e.toLowerCase())}function j(e,t,n){r.isValidHTMLNesting(e,t)||l(n._path,`Invalid HTML: <${t}> cannot be child of <${e}>`)}const I=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function w(t){return y(e.types.react.buildChildren(t.node))}function P(t){return e.types.isStringLiteral(t)||e.types.isNumericLiteral(t)||e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)}function $(t){return e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)?I(t.value?.expression.value):I(t.value)}function k(t,n){const s=h(t.get("openingElement").get("attributes"),w(t)),r=function(e){const t=e.get("openingElement");return S(t.node.name,t.node)}(t),i=function(t){const n=t.get("openingElement"),s=S(n.node.name,n.node);if(e.types.isIdentifier(s))return s.name;if(e.types.isStringLiteral(s))return s.value;if(e.types.isMemberExpression(s))return s.object.name+"."+s.property.name;throw console.error(s),t.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(t),o=t.scope;o.pota=o.pota||{partials:{},components:{},files:{}};const a=o.pota;return a.components[i]||(a.components[i]=o.generateUidIdentifier(i),o.push({id:a.components[i],init:p(n,"createComponent",[r])})),u(a.components[i].name,s?[s]:[])}function _({name:s}){return t.declare(((t,r)=>({name:s,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){l(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},a(e,t,"createPartial"),a(e,t,"createComponent")},exit(t,n){t.traverse({CallExpression(t,n){if(N(t.node)){const s=function(t,n){const s=t.node,r=s.arguments[1].elements,i={},o={};let a=0;const l=[];for(let e=0;e<r.length;e++){const t=r[e].properties,n=t.find((e=>"#pota"===e.key.value));n&&c(t,n),t.length?(a!==e&&(i[a]=e),a++):l.push(r[e])}i[a-1]>-1&&(o.m=i[a-1]+1);for(const e of l)c(r,e);0===s.arguments[1].elements.length&&c(s.arguments,s.arguments[1]);const d=X(s),f=t.scope.getProgramParent();f.pota=f.pota||{partials:{},components:{},files:{}};const g=f.pota;if(!g.partials[d]){g.partials[d]=f.generateUidIdentifier(s.tagName);const t=[s.arguments[0]];s.xmlns&&(o.x=s.xmlns),s.isCustomElement&&(o.c=1),s.isImportNode&&(o.i=1),m(i).length?t.push(e.template.expression.ast`${JSON.stringify(i)}`):m(o).length&&t.push(e.types.objectExpression([])),m(o).length&&t.push(e.template.expression.ast`${JSON.stringify(o)}`),f.push({id:g.partials[d],init:p(n,"createPartial",t)})}return u(g.partials[d].name,s.arguments[1]?[s.arguments[1]]:[])}(t,n);t.replaceWith(e.types.inherits(s,t.node))}}},n)}},JSXFragment:{exit(t,n){const s=function(t){const n=w(t);return 1===n.length?n[0]:n.length>1?e.types.arrayExpression(n):void 0}(t);t.replaceWith(e.types.inherits(s,t.node))}},JSXElement:{exit(t,n){const s=v(t)?E(t,n):k(t,n);t.replaceWith(e.types.inherits(s,t.node))}},JSXAttribute(t){e.types.isJSXElement(t.node.value)&&(t.node.value=e.types.jsxExpressionContainer(t.node.value))}}})))}module.exports=function(e,t={development:!1}){return{plugins:[[_({name:"transform-pota-jsx"}),t]]}};
