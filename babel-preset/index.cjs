"use strict";var e=require("@babel/core"),t=require("@babel/helper-plugin-utils"),n=require("@babel/plugin-syntax-jsx"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting"),i=require("parse5");function a(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o=a(e),p=a(i);function l(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function u(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const c=(t,n,s)=>u(n,"id/"+s,function(t,n,s){return()=>{let i=l(n,`imports/${s}`);return i?e.types.cloneNode(i):(i=r.addNamed(t,s,"pota/jsx-runtime",{importedInterop:"uncompiled",importPosition:"after"}),u(n,`imports/${s}`,i),i)}}(t,n,s)),m=(t,n,r)=>e.types.callExpression(l(t,`id/${n}`)(),r),d=(t,n)=>e.types.callExpression(e.types.identifier(t),n);function f(e,t){throw e.buildCodeFrameError(t)}function g(e,t){const n=e.indexOf(t);return-1!==n&&e.splice(n,1),e}const y=Object.keys;function h(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+x(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function b(t){return e.types.isStringLiteral(t.value.expression)||e.types.isNumericLiteral(t.value.expression)?String(t.value.expression.value):String(t.value.value)}const x=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function v(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(q(r)){if(q(s)){r.value+=H(s),t.push(s),s=e[++n];continue}if(I(s)){s.arguments[0].value=H(r)+$(s),t.push(r),r=s,s=e[++n];continue}}if(I(r)){if(q(s)){r.arguments[0].value+=H(s),t.push(s),s=e[++n];continue}if(I(s)){r.arguments[0].value+=$(s),r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function S(t,n){const r=t.reduce(L,[]);if(n&&n.length>0&&r.push(function(t){let n;if(1===t.length)n=t[0];else{if(!(t.length>1))return;n=e.types.arrayExpression(t)}return e.types.objectProperty(e.types.identifier("children"),n)}(n)),r.length)return e.types.objectExpression(function(e){e&&e.sort(((e,t)=>"children"===e.key?.name?2:e.key?.name?.localeCompare(t.key?.name)));return e}(r))}function L(t,n){if(n="node"in n?n.node:n,e.types.isJSXSpreadAttribute(n)){const r=n.argument;return e.types.isObjectExpression(r)&&!E(r)?t.push(...r.properties):t.push(e.types.spreadElement(r)),t}const r=(s=n.value||e.types.booleanLiteral(!0),e.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;e.types.isStringLiteral(r)&&!e.types.isJSXExpressionContainer(n.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return e.types.isJSXNamespacedName(n.name)?n.name=e.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):e.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=e.types.stringLiteral(n.name.name),t.push(e.types.inherits(e.types.objectProperty(n.name,r),n)),t}const E=t=>t.properties.some((t=>e.types.isObjectProperty(t,{computed:!1,shorthand:!1})&&(e.types.isIdentifier(t.key,{name:"__proto__"})||e.types.isStringLiteral(t.key,{value:"__proto__"}))));function N(t){const n=t.get("openingElement"),r=w(n.node.name,n.node);let s;return e.types.isIdentifier(r)?s=r.name:e.types.isStringLiteral(r)&&(s=r.value),e.types.react.isCompatTag(s)?s:""}function w(t,n){return e.types.isJSXIdentifier(t)?"this"===t.name&&e.types.isReferenced(t,n)?e.types.thisExpression():e.types.isValidIdentifier(t.name,!1)?(t.type="Identifier",t):e.types.stringLiteral(t.name):e.types.isJSXMemberExpression(t)?e.types.memberExpression(w(t.object,t),w(t.property,t)):e.types.isJSXNamespacedName(t)?e.types.stringLiteral(`${t.namespace.name}:${t.name.name}`):t}const j=p.parse("<!DOCTYPE html><html><head></head><body></body></html>").childNodes[1].childNodes[1];function X(e,t){const n=t.replace(/^[^<]+/,"#text").replace(/[^>]+$/,"#text").replace(/>[^<]+</gi,">#text<").replace(/<([a-z0-9-]+)\s+[^>]+>/gi,"<$1>").replace(/^<tr>/i,"<table><tbody><tr>").replace(/<\/tr>$/i,"</tr></tbody></table>").replace(/^<td>/i,"<table><tbody><tr><td>").replace(/<\/td>$/i,"</td></tr></tbody></table>"),r=function(e){const t=p.parseFragment(j,e);return p.serialize(t)}(n);r!==n&&(console.warn("-".repeat(80)),console.warn("User HTML:\n",n),console.warn("Browser HTML:\n",r),console.warn("Original HTML:\n",t),f(e,"\nThe HTML provided is malformed and will yield unexpected output when evaluated by a browser."))}const C=o.types;function J(t,n){const r=N(t),s={tagName:r,content:`<${r}`,props:[]};let i=!1,a=r.includes("-"),o=a,p="";const l=[(u="#pota",c="",e.types.jSXAttribute(e.types.jSXIdentifier(u),e.types.stringLiteral(c)))];var u,c,d;for(const n of t.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&C.isJSXIdentifier(n.node.name)){const t=n.node.name.name;if(a=a||"is"===t,o=o||("img"===r||"iframe"===r)&&"loading"===t,"xmlns"===t&&(i=!0),d=n.node,e.types.isStringLiteral(d.value)||e.types.isNumericLiteral(d.value)||e.types.isStringLiteral(d.value?.expression)||e.types.isNumericLiteral(d.value?.expression)){if("xmlns"===t){p=b(n.node);continue}h(s,t,b(n.node));continue}}l.push(n)}if(!i)switch(r){case"svg":i=!0,p="http://www.w3.org/2000/svg";break;case"math":i=!0,p="http://www.w3.org/1998/Math/MathML"}O(r)?s.content+=" />":s.content+=">";let f=C.react.buildChildren(t.node);!function(e,t){for(const n of t)P(n)&&M(e,n.tagName,n)}(s.tagName,f),f=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(q(s))t.content+=H(s),n.push(s);else{if(!I(s))break;t.content+=$(s),t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(f,s),f=v(f),s.props.unshift(S(l,f)),O(r)||(s.content+=`</${r}>`);const g=m(n,"createPartial",[C.stringLiteral(s.content),C.arrayExpression(s.props)]);return g.isPartial=!0,g.isXML=i,g.xmlns=p,g.isImportNode=o,g.isCustomElement=a,g.tagName=r,g._path=t,g}function I(e){return e.isPartial&&!e.isXML&&!e.isImportNode&&!e.isCustomElement}function P(e){return e.isPartial}function $(e){return e.arguments[0].value}const k=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function O(e){return k.has(e.toLowerCase())}function M(e,t,n){s.isValidHTMLNesting(e,t)||f(n._path,`Invalid HTML: <${t}> cannot be child of <${e}>`)}const _=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function T(t){return v(e.types.react.buildChildren(t.node))}function q(t){return e.types.isStringLiteral(t)||e.types.isNumericLiteral(t)||e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)}function H(t){return e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)?_(t.value?.expression.value):_(t.value)}function A(t,n){const r=S(t.get("openingElement").get("attributes"),T(t)),s=function(e){const t=e.get("openingElement");return w(t.node.name,t.node)}(t),i=function(t){const n=t.get("openingElement"),r=w(n.node.name,n.node);if(e.types.isIdentifier(r))return r.name;if(e.types.isStringLiteral(r))return r.value;if(e.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.error(r),t.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(t),a=t.scope;a.pota=a.pota||{partials:{},components:{},files:{}};const o=a.pota;if(!o.components[i]){o.components[i]=a.generateUidIdentifier(i);const t=o.components[i],r=m(n,"createComponent",[s]),p=a.getBinding(i);switch(p?.kind){case"module":case"const":case"let":p.path.parentPath.insertAfter(e.types.variableDeclaration("const",[e.types.variableDeclarator(t,r)]));break;default:a.push({id:t,init:r})}}return d(o.components[i].name,r?[r]:[])}function D({name:r}){return t.declare(((t,s)=>({name:r,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){f(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},c(e,t,"createPartial"),c(e,t,"createComponent")},exit(t,n){t.traverse({CallExpression(t,n){if(P(t.node)){const r=function(e,t){const n=e.node,r=n.arguments[1].elements,s={},i={};let a=0;const p=[];for(let e=0;e<r.length;e++){const t=r[e].properties,n=t.find((e=>"#pota"===e.key.value));n&&g(t,n),t.length?(a!==e&&(s[a]=e),a++):p.push(r[e])}s[a-1]>-1&&(i.m=s[a-1]+1);for(const e of p)g(r,e);0===n.arguments[1].elements.length&&g(n.arguments,n.arguments[1]);const l=$(n),u=e.scope.getProgramParent();u.pota=u.pota||{partials:{},components:{},files:{}};const c=u.pota;if(!c.partials[l]){X(e,l),c.partials[l]=u.generateUidIdentifier(n.tagName);const r=[n.arguments[0]];n.xmlns&&(i.x=n.xmlns),n.isCustomElement&&(i.c=1),n.isImportNode&&(i.i=1),y(s).length?r.push(o.template.expression.ast`${JSON.stringify(s)}`):y(i).length&&r.push(C.objectExpression([])),y(i).length&&r.push(o.template.expression.ast`${JSON.stringify(i)}`),u.push({id:c.partials[l],init:m(t,"createPartial",r)})}return d(c.partials[l].name,n.arguments[1]?[n.arguments[1]]:[])}(t,n);t.replaceWith(e.types.inherits(r,t.node))}}},n)}},JSXFragment:{exit(t,n){const r=function(t){const n=T(t);return 1===n.length?n[0]:n.length>1?e.types.arrayExpression(n):void 0}(t);t.replaceWith(e.types.inherits(r,t.node))}},JSXElement:{exit(t,n){const r=N(t)?J(t,n):A(t,n);t.replaceWith(e.types.inherits(r,t.node))}},JSXAttribute(t){e.types.isJSXElement(t.node.value)&&(t.node.value=e.types.jsxExpressionContainer(t.node.value))}}})))}module.exports=function(e,t={development:!1}){return{plugins:[[D({name:"transform-pota-jsx"}),t]]}};
