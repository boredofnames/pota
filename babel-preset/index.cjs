"use strict";var e=require("@babel/core"),t=require("@babel/helper-plugin-utils"),n=require("@babel/plugin-syntax-jsx"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting");function i(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function a(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const o=(t,n,s)=>a(n,"id/"+s,function(t,n,s){return()=>{let o=i(n,`imports/${s}`);return o?e.types.cloneNode(o):(o=r.addNamed(t,s,"pota/jsx-runtime",{importedInterop:"uncompiled",importPosition:"after"}),a(n,`imports/${s}`,o),o)}}(t,n,s)),p=(t,n,r)=>e.types.callExpression(i(t,`id/${n}`)(),r),u=(t,n)=>e.types.callExpression(e.types.identifier(t),n);function l(e,t){throw e.buildCodeFrameError(t)}function c(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+g(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function m(t){return e.types.isStringLiteral(t.value.expression)||e.types.isNumericLiteral(t.value.expression)?String(t.value.expression.value):String(t.value.value)}function d(t,n){return e.types.jSXAttribute(e.types.jSXIdentifier(t),e.types.stringLiteral(n))}const g=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function f(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(J(r)){if(J(s)){r.value+=P(s),t.push(s),s=e[++n];continue}if(L(s)){s.arguments[0].value=P(r)+N(s),t.push(r),r=s,s=e[++n];continue}}if(L(r)){if(J(s)){r.arguments[0].value+=P(s),t.push(s),s=e[++n];continue}if(L(s)){r.arguments[0].value+=N(s),s.arguments[1].elements.length&&r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function y(t,n){const r=t.reduce(h,[]);if(n&&n.length>0&&r.push(function(t){let n;if(1===t.length)n=t[0];else{if(!(t.length>1))return;n=e.types.arrayExpression(t)}return e.types.objectProperty(e.types.identifier("children"),n)}(n)),r.length)return e.types.objectExpression(function(e){e&&e.sort(((e,t)=>"children"===e.key?.name?2:e.key?.name?.localeCompare(t.key?.name)));return e}(r))}function h(t,n){if(n="node"in n?n.node:n,e.types.isJSXSpreadAttribute(n)){const r=n.argument;return e.types.isObjectExpression(r)&&!v(r)?t.push(...r.properties):t.push(e.types.spreadElement(r)),t}const r=(s=n.value||e.types.booleanLiteral(!0),e.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;e.types.isStringLiteral(r)&&!e.types.isJSXExpressionContainer(n.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return e.types.isJSXNamespacedName(n.name)?n.name=e.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):e.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=e.types.stringLiteral(n.name.name),t.push(e.types.inherits(e.types.objectProperty(n.name,r),n)),t}const v=t=>t.properties.some((t=>e.types.isObjectProperty(t,{computed:!1,shorthand:!1})&&(e.types.isIdentifier(t.key,{name:"__proto__"})||e.types.isStringLiteral(t.key,{value:"__proto__"}))));function x(t){const n=t.get("openingElement"),r=b(n.node.name,n.node);let s;return e.types.isIdentifier(r)?s=r.name:e.types.isStringLiteral(r)&&(s=r.value),!!e.types.react.isCompatTag(s)&&s}function b(t,n){return e.types.isJSXIdentifier(t)?"this"===t.name&&e.types.isReferenced(t,n)?e.types.thisExpression():e.types.isValidIdentifier(t.name,!1)?(t.type="Identifier",t):e.types.stringLiteral(t.name):e.types.isJSXMemberExpression(t)?e.types.memberExpression(b(t.object,t),b(t.property,t)):e.types.isJSXNamespacedName(t)?e.types.stringLiteral(`${t.namespace.name}:${t.name.name}`):t}function S(t,n){let r=!1;const s=x(t);let i=s.includes("-");const a={tagName:s,content:`<${s} pota`,props:[]},o=[];for(const n of t.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&e.types.isJSXIdentifier(n.node.name)){const t=n.node.name.name;if(i=i||"is"===t||"img"===s&&"loading"===t,"xmlns"===t&&(r=!0),"xmlns"!==t&&(u=n.node,e.types.isStringLiteral(u.value)||e.types.isNumericLiteral(u.value)||e.types.isStringLiteral(u.value?.expression)||e.types.isNumericLiteral(u.value?.expression))){c(a,t,m(n.node));continue}}o.push(n)}var u;if(!r)switch(s){case"svg":o.push(d("xmlns","http://www.w3.org/2000/svg")),r=!0;break;case"math":o.push(d("xmlns","http://www.w3.org/1998/Math/MathML")),r=!0;break;case"foreignObject":o.push(d("xmlns","http://www.w3.org/1999/xhtml")),r=!0}I(s)?a.content+=" />":a.content+=">";let l=e.types.react.buildChildren(t.node);!function(e,t){for(const n of t)L(n)&&X(e,n.tagName,n)}(a.tagName,l),l=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(J(s))t.content+=P(s),n.push(s);else{if(!L(s))break;t.content+=N(s),s.arguments[1].elements.length&&t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(l,a),l=f(l);const g=y(o,l);g?a.props.unshift(g):a.content=a.content.replace(/^<([^\s]+) pota/,"<$1"),I(s)||(a.content+=`</${s}>`);const h=p(n,i?"createPartialImportNode":"createPartial",[e.types.stringLiteral(a.content),e.types.arrayExpression(a.props)]);return h.isXML=r,h.isImportNode=i,h.isPartial=!0,h.tagName=s,h._path=t,h}function L(e){return e.isPartial&&!e.isXML&&!e.isImportNode}function N(e){return e.arguments[0].value}const E=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function I(e){return E.has(e.toLowerCase())}function X(e,t,n){e.includes("-")||t.includes("-")||s.isValidHTMLNesting(e,t)||l(n._path,`Invalid HTML: <${t}> cannot be child of <${e}>`)}const w=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function j(t){return f(e.types.react.buildChildren(t.node))}function J(t){return e.types.isStringLiteral(t)||e.types.isNumericLiteral(t)||e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)}function P(t){return e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)?w(t.value?.expression.value):w(t.value)}function C(t,n){const r=y(t.get("openingElement").get("attributes"),j(t)),s=function(e){const t=e.get("openingElement");return b(t.node.name,t.node)}(t),i=function(t){const n=t.get("openingElement"),r=b(n.node.name,n.node);if(e.types.isIdentifier(r))return r.name;if(e.types.isStringLiteral(r))return r.value;if(e.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.log(r),t.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(t),a=t.scope;a.pota=a.pota||{partials:{},components:{},files:{}};const o=a.pota;return o.components[i]||(o.components[i]=a.generateUidIdentifier("_"+i),a.push({id:o.components[i],init:p(n,"createComponent",[s])})),u(o.components[i].name,r?[r]:[])}function k({name:r}){return t.declare(((t,s)=>({name:r,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){l(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},o(e,t,"createPartial"),o(e,t,"createPartialImportNode"),o(e,t,"createComponent")},exit(t,n){t.traverse({CallExpression(t,n){if(t.node.isPartial){const r=function(t,n){0===t.node.arguments[1].elements.length&&function(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}(t.node.arguments,t.node.arguments[1]);const r=N(t.node),s=t.scope.getProgramParent();s.pota=s.pota||{partials:{},components:{},files:{}};const i=s.pota;if(!i.partials[r]){i.partials[r]=s.generateUidIdentifier("_partial");const a=[t.node.arguments[0]],o=t.node.arguments[1]?t.node.arguments[1].elements[0].properties.find((e=>"xmlns"===e?.key?.name))?.value?.value:void 0;o&&a.push(e.types.stringLiteral(o)),s.push({id:i.partials[r],init:p(n,t.node.isImportNode?"createPartialImportNode":"createPartial",a)})}return u(i.partials[r].name,t.node.arguments[1]?[t.node.arguments[1]]:[])}(t,n);t.replaceWith(e.types.inherits(r,t.node))}}},n)}},JSXFragment:{exit(t,n){const r=function(t){const n=j(t);return 1===n.length?n[0]:n.length>1?e.types.arrayExpression(n):void 0}(t);t.replaceWith(e.types.inherits(r,t.node))}},JSXElement:{exit(t,n){const r=x(t)?S(t,n):C(t,n);t.replaceWith(e.types.inherits(r,t.node))}},JSXAttribute(t){e.types.isJSXElement(t.node.value)&&(t.node.value=e.types.jsxExpressionContainer(t.node.value))}}})))}module.exports=function(e,t={development:!1}){return{plugins:[[k({name:"transform-pota-jsx"}),t]]}};
