"use strict";var e=require("@babel/core"),t=require("@babel/helper-plugin-utils"),n=require("@babel/plugin-syntax-jsx"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting"),i=require("jsdom");function a(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function o(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const p=(t,n,s)=>o(n,"id/"+s,function(t,n,s){return()=>{let i=a(n,`imports/${s}`);return i?e.types.cloneNode(i):(i=r.addNamed(t,s,"pota/jsx-runtime",{importedInterop:"uncompiled",importPosition:"after"}),o(n,`imports/${s}`,i),i)}}(t,n,s)),l=(t,n,r)=>e.types.callExpression(a(t,`id/${n}`)(),r),u=(t,n)=>e.types.callExpression(e.types.identifier(t),n);function c(e,t){throw e.buildCodeFrameError(t)}function m(e,t){const n=e.indexOf(t);return-1!==n&&e.splice(n,1),e}const d=Object.keys;function f(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+y(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function g(t){return e.types.isStringLiteral(t.value.expression)||e.types.isNumericLiteral(t.value.expression)?String(t.value.expression.value):String(t.value.value)}const y=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function h(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(k(r)){if(k(s)){r.value+=T(s),t.push(s),s=e[++n];continue}if(X(s)){s.arguments[0].value=T(r)+J(s),t.push(r),r=s,s=e[++n];continue}}if(X(r)){if(k(s)){r.arguments[0].value+=T(s),t.push(s),s=e[++n];continue}if(X(s)){r.arguments[0].value+=J(s),r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function b(t,n){const r=t.reduce(x,[]);if(n&&n.length>0&&r.push(function(t){let n;if(1===t.length)n=t[0];else{if(!(t.length>1))return;n=e.types.arrayExpression(t)}return e.types.objectProperty(e.types.identifier("children"),n)}(n)),r.length)return e.types.objectExpression(function(e){e&&e.sort(((e,t)=>"children"===e.key?.name?2:e.key?.name?.localeCompare(t.key?.name)));return e}(r))}function x(t,n){if(n="node"in n?n.node:n,e.types.isJSXSpreadAttribute(n)){const r=n.argument;return e.types.isObjectExpression(r)&&!v(r)?t.push(...r.properties):t.push(e.types.spreadElement(r)),t}const r=(s=n.value||e.types.booleanLiteral(!0),e.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;e.types.isStringLiteral(r)&&!e.types.isJSXExpressionContainer(n.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return e.types.isJSXNamespacedName(n.name)?n.name=e.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):e.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=e.types.stringLiteral(n.name.name),t.push(e.types.inherits(e.types.objectProperty(n.name,r),n)),t}const v=t=>t.properties.some((t=>e.types.isObjectProperty(t,{computed:!1,shorthand:!1})&&(e.types.isIdentifier(t.key,{name:"__proto__"})||e.types.isStringLiteral(t.key,{value:"__proto__"}))));function S(t){const n=t.get("openingElement"),r=L(n.node.name,n.node);let s;return e.types.isIdentifier(r)?s=r.name:e.types.isStringLiteral(r)&&(s=r.value),e.types.react.isCompatTag(s)?s:""}function L(t,n){return e.types.isJSXIdentifier(t)?"this"===t.name&&e.types.isReferenced(t,n)?e.types.thisExpression():e.types.isValidIdentifier(t.name,!1)?(t.type="Identifier",t):e.types.stringLiteral(t.name):e.types.isJSXMemberExpression(t)?e.types.memberExpression(L(t.object,t),L(t.property,t)):e.types.isJSXNamespacedName(t)?e.types.stringLiteral(`${t.namespace.name}:${t.name.name}`):t}const E=new i.JSDOM("<!DOCTYPE html>").window.document.body;function w(t,n){const r=S(t),s={tagName:r,content:`<${r}`,props:[]};let i=!1,a=r.includes("-"),o=a,p="";const u=[(c="#pota",m="",e.types.jSXAttribute(e.types.jSXIdentifier(c),e.types.stringLiteral(m)))];var c,m,d;for(const n of t.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&e.types.isJSXIdentifier(n.node.name)){const t=n.node.name.name;if(a=a||"is"===t,o=o||("img"===r||"iframe"===r)&&"loading"===t,"xmlns"===t&&(i=!0),d=n.node,e.types.isStringLiteral(d.value)||e.types.isNumericLiteral(d.value)||e.types.isStringLiteral(d.value?.expression)||e.types.isNumericLiteral(d.value?.expression)){if("xmlns"===t){p=g(n.node);continue}f(s,t,g(n.node));continue}}u.push(n)}if(!i)switch(r){case"svg":i=!0,p="http://www.w3.org/2000/svg";break;case"math":i=!0,p="http://www.w3.org/1998/Math/MathML"}I(r)?s.content+=" />":s.content+=">";let y=e.types.react.buildChildren(t.node);!function(e,t){for(const n of t)C(n)&&$(e,n.tagName,n)}(s.tagName,y),y=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(k(s))t.content+=T(s),n.push(s);else{if(!X(s))break;t.content+=J(s),t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(y,s),y=h(y),s.props.unshift(b(u,y)),I(r)||(s.content+=`</${r}>`);const x=l(n,"createPartial",[e.types.stringLiteral(s.content),e.types.arrayExpression(s.props)]);return x.isPartial=!0,x.isXML=i,x.xmlns=p,x.isImportNode=o,x.isCustomElement=a,x.tagName=r,x._path=t,x}function N(t,n){const r=t.node,s=r.arguments[1].elements,i={},a={};let o=0;const p=[];for(let e=0;e<s.length;e++){const t=s[e].properties,n=t.find((e=>"#pota"===e.key.value));n&&m(t,n),t.length?(o!==e&&(i[o]=e),o++):p.push(s[e])}i[o-1]>-1&&(a.m=i[o-1]+1);for(const e of p)m(s,e);0===r.arguments[1].elements.length&&m(r.arguments,r.arguments[1]);const f=J(r),g=t.scope.getProgramParent();g.pota=g.pota||{partials:{},components:{},files:{}};const y=g.pota;if(!y.partials[f]){!function(e,t){const n=t.replace(/^([^<]+)/,"").replace(/([^>]+)$/,"").replace(/>([^<]+)</gi,"><").replace(/<([a-z0-9-]+)\s+[^>]+>/gi,"<$1>").replace(/^<tr>/i,"<table><tbody><tr>").replace(/<\/tr>$/i,"</tr></tbody></table>").replace(/^<td>/i,"<table><tbody><tr><td>").replace(/<\/td>$/i,"</td></tr></tbody></table>");E.innerHTML=n;const r=E.innerHTML;r!==n&&(console.warn("-".repeat(80)),console.warn("User HTML:\n",n),console.warn("Browser HTML:\n",r),console.warn("Original HTML:\n",t),c(e,"\nThe HTML provided is malformed and will yield unexpected output when evaluated by a browser."))}(t,f),y.partials[f]=g.generateUidIdentifier(r.tagName);const s=[r.arguments[0]];r.xmlns&&(a.x=r.xmlns),r.isCustomElement&&(a.c=1),r.isImportNode&&(a.i=1),d(i).length?s.push(e.template.expression.ast`${JSON.stringify(i)}`):d(a).length&&s.push(e.types.objectExpression([])),d(a).length&&s.push(e.template.expression.ast`${JSON.stringify(a)}`),g.push({id:y.partials[f],init:l(n,"createPartial",s)})}return u(y.partials[f].name,r.arguments[1]?[r.arguments[1]]:[])}function X(e){return e.isPartial&&!e.isXML&&!e.isImportNode&&!e.isCustomElement}function C(e){return e.isPartial}function J(e){return e.arguments[0].value}const j=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function I(e){return j.has(e.toLowerCase())}function $(e,t,n){s.isValidHTMLNesting(e,t)||c(n._path,`Invalid HTML: <${t}> cannot be child of <${e}>`)}const M=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function P(t){return h(e.types.react.buildChildren(t.node))}function k(t){return e.types.isStringLiteral(t)||e.types.isNumericLiteral(t)||e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)}function T(t){return e.types.isStringLiteral(t.value?.expression)||e.types.isNumericLiteral(t.value?.expression)?M(t.value?.expression.value):M(t.value)}function _(t,n){const r=b(t.get("openingElement").get("attributes"),P(t)),s=function(e){const t=e.get("openingElement");return L(t.node.name,t.node)}(t),i=function(t){const n=t.get("openingElement"),r=L(n.node.name,n.node);if(e.types.isIdentifier(r))return r.name;if(e.types.isStringLiteral(r))return r.value;if(e.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.error(r),t.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(t),a=t.scope;a.pota=a.pota||{partials:{},components:{},files:{}};const o=a.pota;if(!o.components[i]){o.components[i]=a.generateUidIdentifier(i);const t=o.components[i],r=l(n,"createComponent",[s]),p=a.getBinding(i);switch(p?.kind){case"module":case"const":case"let":p.path.parentPath.insertAfter(e.types.variableDeclaration("const",[e.types.variableDeclarator(t,r)]));break;default:a.push({id:t,init:r})}}return u(o.components[i].name,r?[r]:[])}function O({name:r}){return t.declare(((t,s)=>({name:r,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){c(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},p(e,t,"createPartial"),p(e,t,"createComponent")},exit(t,n){t.traverse({CallExpression(t,n){if(C(t.node)){const r=N(t,n);t.replaceWith(e.types.inherits(r,t.node))}}},n)}},JSXFragment:{exit(t,n){const r=function(t){const n=P(t);return 1===n.length?n[0]:n.length>1?e.types.arrayExpression(n):void 0}(t);t.replaceWith(e.types.inherits(r,t.node))}},JSXElement:{exit(t,n){const r=S(t)?w(t,n):_(t,n);t.replaceWith(e.types.inherits(r,t.node))}},JSXAttribute(t){e.types.isJSXElement(t.node.value)&&(t.node.value=e.types.jsxExpressionContainer(t.node.value))}}})))}module.exports=function(e,t={development:!1}){return{plugins:[[O({name:"transform-pota-jsx"}),t]]}};
